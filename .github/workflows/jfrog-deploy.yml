name: Build & Push to JFrog

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # ────────────────────────────────────────────────────────────
  # Secrets necesarios en GitHub → Settings → Secrets → Actions:
  #   JFROG_URL          → https://tuservidor.jfrog.io
  #   JFROG_ACCESS_TOKEN → Access Token generado en JFrog
  #   JFROG_REPO         → jfrog-docker
  # ────────────────────────────────────────────────────────────
  IMAGE_NAME: hello-world-app

jobs:
  # ─── 1. Lint & Test ────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Smoke test – import check
        run: python -c "import app.main; print('✅ Import OK')"

  # ─── 2. Build image & Push to JFrog ────────────────────────
  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      # ── Setup JFrog CLI con Access Token (evita 401) ──
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ secrets.JFROG_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}

      # ── Docker login a JFrog usando Access Token ──
      - name: Docker login to JFrog
        run: |
          DOCKER_REGISTRY=$(echo "${{ secrets.JFROG_URL }}" | sed 's|https://||')
          echo "${{ secrets.JFROG_ACCESS_TOKEN }}" | docker login "$DOCKER_REGISTRY" \
            --username=access-token --password-stdin

      # ── Build Docker image ──
      - name: Build Docker image
        run: |
          DOCKER_REGISTRY=$(echo "${{ secrets.JFROG_URL }}" | sed 's|https://||')
          TAG="${DOCKER_REGISTRY}/${{ secrets.JFROG_REPO }}/${IMAGE_NAME}"
          docker build \
            -t "${TAG}:latest" \
            -t "${TAG}:${{ github.sha }}" \
            .

      # ── Push image to JFrog ──
      - name: Push Docker image to JFrog
        run: |
          DOCKER_REGISTRY=$(echo "${{ secrets.JFROG_URL }}" | sed 's|https://||')
          TAG="${DOCKER_REGISTRY}/${{ secrets.JFROG_REPO }}/${IMAGE_NAME}"
          docker push "${TAG}:latest"
          docker push "${TAG}:${{ github.sha }}"

      # ── Publicar info de build en JFrog ──
      - name: Publish Build Info
        run: |
          jf rt build-collect-env
          jf rt build-add-git
          jf rt build-publish
